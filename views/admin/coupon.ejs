<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Ticker Admin </title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <!-- Bootstrap CSS-->
  <link rel="stylesheet" href="/admin/vendor/bootstrap/css/bootstrap.min.css">
  <!-- Font Awesome CSS-->
  <link rel="stylesheet" href="/admin/vendor/font-awesome/css/font-awesome.min.css">
  <!-- Custom Font Icons CSS-->
  <link rel="stylesheet" href="/admin/css/font.css">
  <!-- Google fonts - Muli-->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Muli:300,400,700">
  <!-- theme stylesheet-->
  <link rel="stylesheet" href="/admin/css/style.default.css" id="theme-stylesheet">
  <!-- Custom stylesheet - for your changes-->
  <link rel="stylesheet" href="/admin/css/custom.css">
  <!-- Favicon-->
  <link rel="shortcut icon" href="/image/download.png">
  <!-- Tweaks for older IEs--><!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script><![endif]-->
</head>

<body>
  <header class="header">
    <nav class="navbar navbar-expand-lg">
      <!-- <div class="search-panel">
        <div class="search-inner d-flex align-items-center justify-content-center">
          <div class="close-btn">Close <i class="fa fa-close"></i></div>
          <form id="searchForm" action="/admin/categorySearch">
            <div class="form-group">
              <input type="search" name="search" placeholder="What are you searching for...">
              <button type="submit" class="submit">Search</button>
            </div>
          </form>
        </div>
      </div> -->

      <div class="container-fluid d-flex align-items-center justify-content-between">
        <div class="navbar-header">
          <!-- Navbar Header--><a href="/admin/dashboard" class="navbar-brand">
            <div class="brand-text brand-big visible text-uppercase"><strong
                class="text-primary">TICKER</strong><strong>ADMIN</strong></div>
            <div class="brand-text brand-sm"><strong class="text-primary">T</strong><strong>A</strong></div>
          </a>
          <!-- Sidebar Toggle Btn-->
          <button class="sidebar-toggle"><i class="fa fa-long-arrow-left"></i></button>
        </div>

        <div class="right-menu list-inline no-margin-bottom ">
          <form id="searchForm" action="/admin/categorySearch">
            <div class="form-group d-flex">

              <input name="search" id="search" type="search" placeholder="What are you searching for..."
                class="mr-sm-3 form-control form-control">
              <button style="width: 90px;" type="submit" class="btn btn-primary">search</button>
            </div>
          </form>
        </div>
        <div class="right-menu list-inline no-margin-bottom">


          <!-- Log out               -->

          <div class="list-inline-item logout">


            <a href="/admin/logout" class="btn btn-dark btn-sm ">Logout<i class="icon-logout"></i></a>

          </div>

        </div>
      </div>
    </nav>
  </header>
  <div class="d-flex align-items-stretch">
    <!-- Sidebar Navigation-->
    <nav id="sidebar">
      <!-- Sidebar Header-->,

      <ul class="list-unstyled">
        <li><a href="/admin/dashboard"> <i class="icon-home"></i>Dashboard </a></li>
        <li><a href="/admin/product"> <i class=" icon icon-pencil-case"></i>Products</a></li>
        <li><a href="/admin/user"><i class="icon icon-user"></i>Users</a></li>
        <li ><a href="/admin/category"> <i class="icon-layers"></i>Category</a></li>
        <li><a href="/admin/orderMgt"> <i class="icon-new-file"></i>Orders</a></li>

        <li class="active"><a href="/admin/couponMangement"> <i class="icon icon-check"></i>Coupon</a></li>
        <li><a href="#exampledropdownDropdown" aria-expanded="false" data-toggle="collapse"> <i class="icon-windows"></i>Offer</a>
          <ul id="exampledropdownDropdown" class="collapse list-unstyled ">
            <li><a class="active" href="/admin/category-offers"> <i class="icon icon-light-bulb"></i>Category offer</a></li>
        <li><a href="/admin/product-offers"> <i class="icon icon-light-bulb"></i>Product Offers</a></li>
          </ul>
        </li>
        <li><a href="/admin/sales-report"> <i class="icon-page"></i>Sales Repoart</a></li>
        <!-- <li><a href=""> <i class="icon-layers"></i>Category</a></li>
        <li><a href=""> <i class="icon icon-picture"></i>Banner</a></li> -->
      </ul><!-- Sidebar Navidation Menus-->

    </nav>
    <!-- Sidebar Navigation end-->
    <div class="page-content">
      <!-- Page Header-->
      <div class="page-header no-margin-bottom ">
        <div class="container-fluid">
          <h2 class="h5 no-margin-bottom ">C o u p o n s</h2>
          <div class="block-body text-center d-flex justify-content-end">
            <button type="button" data-toggle="modal" data-target="#myModal" class="btn btn-primary">+ Add
              coupon</button>
            <!-- Modal-->
            <div id="myModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true"
              class="modal fade text-left">
              <div role="document" class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header"><strong id="exampleModalLabel" class="modal-title">Add new coupon</strong>
                    <button type="button" data-dismiss="modal" aria-label="Close" class="close"><span
                        aria-hidden="true">×</span></button>
                  </div>
                  <div class="modal-body">

                    <form action="/admin/add-coupon" method="post" id="couponForm">

                      <div class="form-group">
                        <label>Coupon Code</label>
                        <p id="couponcodeMessage" class="text-danger"></p>
                        <input id="couponCode" name="couponCode" type="text" placeholder="Enter Coupon Code"
                          class="form-control">
                      </div>
                      <div class="form-group">
                        <label>offer-%</label>
                        <p id="offerMessage" class="text-danger"></p>
                        
                      </div><input id="offer" name="offer" type="numbers" min="5" max="60" placeholder="Enter Coupon offer"
                          class="form-control">
                      <div class="form-group">
                        <label>Minimum Purchas
                          e Amount</label>
                        <p id="minPriceMessage" class="text-danger"></p>
                        <input id="minPrice" name="minPrice" type="number" min="100" placeholder="Enter minimum Purchase"
                          class="form-control">
                      </div>
                      <div class="form-group">
                        <label>Max Redeemable amount</label>
                        <p id="maxredeemMessage" class="text-danger"></p>
                        <input id="maxRedeem" name="maxRedeem" type="number" min="0"
                          placeholder="Enter max Redeemable amount" class="form-control">
                      </div>
                      <div class="form-group">
                        <label>Validity</label>
                        <p id="validityMessage" class="text-danger"></p>
                        <input id="date" name="date" type="date" placeholder="Choose Validity " class="form-control">
                      </div>

                      <div class="modal-footer">
                        <span class="showMessage mr-5 text-danger" id="showMessage"></span>
                        <button type="button" data-dismiss="modal" class="btn btn-secondary">Close</button>
                        <button id="submitButton" type="submit" class="btn btn-primary">Save</button>
                      </div>
                    </form>
                  </div>

                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Breadcrumb-->
      <div class="container-fluid">
        <ul class="breadcrumb">
          <li class="breadcrumb-item"><a href="/admin/dashboard">Home</a></li>
          <li class="breadcrumb-item active">Coupon </li>
        </ul>


        <!-- ---------------------table------------------------- -->
        <div class="col-lg-12">
          <div class="block">

            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>NO</th>
                    <th>CouponCode</th>
                    <th>%</th>
                    <th>min.price</th>
                    <th>max.Redeem</th>
                    <th>Validity</th>
                    <th>Status</th>
                    <th>Action</th>
                    <!-- <th>Edit</th> -->
                    <th>Delete</th>

                  </tr>
                </thead>
                <tbody>
                  <% if (couponData.length>0){%>

                    <% for(let i=0 ; i <couponData.length ; i++){ %>
                      <tr>
                        <td>
                          <%= i + 1 %>
                        </td>
                        <td>
                          <%= couponData[i].couponCode %>
                        </td>
                        <td>
                          <%= couponData[i].offer %>
                        </td>
                        <td>
                          <%= couponData[i].minPrice %>
                        </td>
                        <td>
                          <%= couponData[i].maxRedeemable %>
                        </td>
                        <td>
                          <%= new Date(couponData[i].validity).toLocaleDateString() %>
                        </td>
                        <td class="<%= couponData[i].status ? 'text-success' : 'text-danger' %>">
                          <%= couponData[i].status?'Listed':'Unlisted' %>
                        </td>
                        <td>
                          
                            <a class="btn <%=(couponData[i].status)?"btn-outline-danger":"btn-outline-success" %> btn-sm"
                              onclick="return changeStatus('<%=couponData[i]._id %>')"><%=(couponData[i].status)?"Unlist":"List"%></a>
                            


                        </td>

                        <!-- <th>
                          <div class="block-body text-center d-flex ">
                            <button type="button" data-toggle="modal" data-target="#editmyModal"
                              class="btn btn-outline-success icon icon-new-file btn-sm"
                              onclick="editCategory('<%= couponData[i]._id %>','<%= couponData[i].couponCode%>')"></button>

                          </div>
                        </th> -->
                        <th>
                          <a class="btn btn-outline-danger icon icon-close btn-sm" onclick="deleteCoupon('<%=couponData[i]._id%>')"></a>
                        </th>
                      </tr>
                      <% } %>
                        <% } else { %>
                          <tr>
                            <td colspan="4">
                              <p class=" text-white fw-bolder">No coupons found in the database</p>
                            </td>
                          </tr>
                          <% } %>
                </tbody>
              </table>
            </div>
          </div>
          <div class="card-footer py-4 ">
            <nav aria-label="...">
              <ul class="pagination justify-content-center mb-0">
                <%if(currentPage>1){%>
                  <li class="page-item ">
                    <a class="page-link " href="?page=<%= currentPage - 1 %>" tabindex="-1">
                      < </a>
                  </li>
                  <%}%>
                    <%for (let i=1;i<=totalPages;i++){%>
                      <%if(i==currentPage){%>
                        <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                          <a class="page-link" href="#">
                            <%=i%>
                          </a>


                        </li>
                        <% }else{ %>


                          <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                            <a class="page-link" href="?page=<%=i%>&search=<%=search%>">
                              <%=i%>
                            </a>
                          </li>
                          <%}%>
                            <%}%>
                              <% if(currentPage < totalPages){%>
                                <li class="page-item">
                                  <a class="page-link" href="?page=<%=totalPages%>&search=<%=search%>">></a>


                                </li>
                                <%}%>
              </ul>
            </nav>
          </div>
        </div>

        <!-- edit Modal-->
        <div id="editmyModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true"
          class="modal fade text-left">
          <div role="document" class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header"><strong id="exampleModalLabel" class="modal-title">Edit
                  coupon</strong>
                <button type="button" data-dismiss="modal" aria-label="Close" class="close"><span
                    aria-hidden="true">×</span></button>
              </div>
              <div class="modal-body">


                <div id="categoryeditcreate">
                  <input name="editCategoryId" type="hidden" id="CategoryId">
                  <input name="editCategoryName" type="text" placeholder="Category name" id="editCategoryName"
                    maxlength="18">

                  <div class="modal-footer">
                    <span class="seenMessage mr-5 text-danger" id="seenMessage"></span>
                    <a type="button" data-dismiss="modal" class="btn btn-outline-secondary">Close</a>

                    <button type="submit" onclick="validateCategoryName(),saveEditCategory()"
                      class="btn btn-outline-primary" id="submitbtn">Save Changes</button>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>


      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>
    <script>


      function editCategory(categoryId, categoryName) {
        // Set the coupon ID and name in the modal inputs
        document.getElementById('CategoryId').value = categoryId;
        document.getElementById('editCategoryName').value = categoryName;

        // Show the modal
        $('#editmyModal').modal('show');
      }




      async function validateCouponAdd(event) {
        event.preventDefault();
        let valid = true;
        // const formData =document.getElementById('couponForm');
        const couponCode = document.getElementById('couponCode').value;
        const offer = document.getElementById('offer').value;
      
        const minPrice = document.getElementById('minPrice').value;
        const maxRedeem = document.getElementById('maxRedeem').value;
        const date = document.getElementById('date').value;

        const couponCodeMessage = document.getElementById('couponcodeMessage');
        const offerMessage = document.getElementById('offerMessage');
        const minPriceMessage = document.getElementById('minPriceMessage');
        const maxRedeemMessage = document.getElementById('maxredeemMessage');
        const validityMessage = document.getElementById('validityMessage');
        const showMessage = document.getElementById('showMessage');

        const couponCodeRegex = /^[A-Za-z0-9]{4,15}$/;
        const numberRegex = /^[0-9]+$/;
        const today = new Date().toISOString().split('T')[0];

        couponCodeMessage.textContent = '';
        offerMessage.textContent = '';
        minPriceMessage.textContent = '';
        maxRedeemMessage.textContent = '';
        validityMessage.textContent = '';

        if (!couponCodeRegex.test(couponCode)) {
          couponCodeMessage.textContent = "Coupon Code must be 4-15 characters long, alphanumeric, and contain no spaces or special characters.";
          valid = false;
        }else{
          couponCodeMessage.textContent = ""
        }

       
  if (!numberRegex.test(offer) || parseInt(offer) < 5 || parseInt(offer) > 60) {
    offerMessage.textContent = "Offer must contain only numbers, offer must be between 5 and 60.";
    valid = false;
  
        }else{
          offerMessage.textContent = ""
        }

        if (!numberRegex.test(minPrice) || parseInt(minPrice) < 100 || parseInt(minPrice) > 6000) {
          minPriceMessage.textContent = "Minimum Purchase Amount must contain only numbers.";
          valid = false;
        }else{
          minPriceMessage.textContent = ""
        }

        if (!numberRegex.test(maxRedeem)) {
          maxRedeemMessage.textContent = "Max Redeemable Amount must contain only numbers.";
          valid = false;
        }else{
          maxRedeemMessage.textContent = ""
        }

        if (date < today) {
          validityMessage.textContent = "Validity date must be today or a future date.";
          valid = false;
        }else{
          validityMessage.textContent = ""
        }

        if (valid) {
          showMessage.textContent = "";

          const formData = {
          couponCode,
          offer,
          minPrice,
          maxRedeem,
          date, 
        }
 
       
        try {
          const response = await fetch("/admin/add-coupon", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
          });
        
          const data = await response.json();
          if (data.success) {
            Swal.fire({
              icon: 'success',
              title: data.message,
              showConfirmButton: false,
              timer: 1000,
              toast: true,
              position: 'top-end'
            }).then(()=>{
              $('#myModal').modal('hide');
              window.location.reload()
            })
          } else {
            Swal.fire({
              icon: 'error',
              title: data.message,
              showConfirmButton: false,
              timer: 1000,
              toast: true,
              position: 'top-end'
            })
          }
        } catch (error) {
          console.log(error.message);
          Swal.fire({
            icon: 'error',
            title: 'something went wrong . Please try again',
            showConfirmButton: false,
            timer: 1000,
            toast: true,
            position: 'top-end'
          })
        }
        }

        

      }
      document.getElementById('couponForm').addEventListener('submit', validateCouponAdd);


      // function saveEditCategory() {
      //   if (validateCategoryName()) {
      //     const categoryId = document.getElementById('CategoryId').value;
      //     const categoryName = document.getElementById('editCategoryName').value;

      //     // Make sure coupon ID and name are not empty
      //     if (!categoryId || !categoryName) {
      //       alert('Category ID or name cannot be empty');
      //       return;
      //     }

      //     // Make a PUT request to update the coupon
      //     fetch('/admin/edit-coupon', {
      //       method: 'PUT',
      //       headers: {
      //         'Content-Type': 'application/json'
      //       },
      //       body: JSON.stringify({
      //         categoryId: categoryId,
      //         categoryName: categoryName
      //       })
      //     })
      //       .then(res => res.json())
      //       .then(data => {
      //         if (data.success) {
      //           // Close the modal
      //           $('#editmyModal').modal('hide');
      //           Swal.fire({
      //             icon: 'success',
      //             title: 'Success!',
      //             text: 'Category updated successFully'
      //           }).then(() => {
      //             // Close the modal
      //             $('#editmyModal').modal('hide');
      //             location.reload();
      //           });



      //         } else if (data.error) {
      //           $('#editmyModal').modal('hide');
      //           Swal.fire({
      //             icon: 'error',
      //             title: 'Oops...',
      //             text: 'Failed to updated coupon!'
      //           })
      //         }
      //       })
      //       .catch(error => {
      //         console.error('Error updating coupon:', error);
      //         Swal.fire({
      //           icon: 'error',
      //           title: 'Oops...',
      //           text: 'filed to update coupon!'
      //         })
      //       });
      //   }
      // }




    </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
      function changeStatus(couponId) {
        return Swal.fire({
          title: "Are you sure you want to unlist this coupon?",
          text: "This action cannot be undone.",
          icon: "warning",
          toast: true,
          showCancelButton: true,
          confirmButtonColor: "#d33",
          cancelButtonColor: "#1eba0a",
          confirmButtonText: "Yes, unlist it!",
        }).then(async (result) => {
          if (result.isConfirmed) {
           
            try {
              // Make AJAX request to backend
              const response = await fetch(`/admin/status-coupon`, {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                },
                body:JSON.stringify({couponId})
              })
              
            const data = await response.json();
            if (data.success) {
              Swal.fire({
                icon: 'success',
                title: data.message,
                showConfirmButton: false,
                timer: 1000,
                toast: true,
                position: 'top-end'
              }).then(()=>{
                $('#editmyModal').modal('hide');
                window.location.reload()
              })
            } else {
              Swal.fire({
                icon: 'error',
                title: data.message,
                showConfirmButton: false,
                timer: 1000,
                toast: true,
                position: 'top-end'
              })
            }
            } catch (error) {
              console.log(error.message);
            }
          }
        });
      }

      function deleteCoupon(couponId) {
        return Swal.fire({
          title: "Are you sure you want to delete this coupon?",
          icon: "question",
          showCancelButton: true,
          confirmButtonColor: "#1eba0a",
          cancelButtonColor: "#d33",
          confirmButtonText: "Yes, Delete it!",
        }).then(async (result) => {
          if (result.isConfirmed) {
            // Make AJAX request to backend
            try {
              const response = await fetch(`/admin/delete-coupon?couponId=${couponId}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              // body: JSON.stringify({ categoryId }), 
            })
            const data = await response.json();
            if (data.success) {
              Swal.fire({
                icon: 'success',
                title: data.message,
                showConfirmButton: false,
                timer: 1000,
                toast: true,
                position: 'top-end'
              }).then(()=>{
                window.location.reload()
              })
            } else {
              Swal.fire({
                icon: 'error',
                title: data.message,
                showConfirmButton: false,
                timer: 1000,
                toast: true,
                position: 'top-end'
              })
            }
            } catch (error) {
              console.log(error.message)
            }
           
          }
        });
      }








    </script>

    </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- JavaScript files-->
    <script src="/admin/vendor/jquery/jquery.min.js"></script>
    <script src="/admin/vendor/popper.js/umd/popper-utils.min.js"> </script>
    <script src="/admin/vendor/bootstrap/js/bootstrap.min.js"></script>
    <script src="/admin/vendor/jquery.cookie/jquery.cookie.js"> </script>
    <script src="/admin/vendor/chart.js/Chart.min.js"></script>
    <script src="/admin/vendor/jquery-validation/jquery.validate.min.js"></script>
    <script src="/admin/js/front.js"></script>
</body>

</html>