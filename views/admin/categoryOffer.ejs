<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Ticker Admin </title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <!-- Bootstrap CSS-->
  <link rel="stylesheet" href="/admin/vendor/bootstrap/css/bootstrap.min.css">
  <!-- Font Awesome CSS-->
  <link rel="stylesheet" href="/admin/vendor/font-awesome/css/font-awesome.min.css">
  <!-- Custom Font Icons CSS-->
  <link rel="stylesheet" href="/admin/css/font.css">
  <!-- Google fonts - Muli-->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Muli:300,400,700">
  <!-- theme stylesheet-->
  <link rel="stylesheet" href="/admin/css/style.default.css" id="theme-stylesheet">
  <!-- Custom stylesheet - for your changes-->
  <link rel="stylesheet" href="/admin/css/custom.css">
  <!-- Favicon-->
  <link rel="shortcut icon" href="/image/download.png">
  <!-- Tweaks for older IEs--><!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script><![endif]-->
</head>

<body>
  <header class="header">
    <nav class="navbar navbar-expand-lg">
      <!-- <div class="search-panel">
        <div class="search-inner d-flex align-items-center justify-content-center">
          <div class="close-btn">Close <i class="fa fa-close"></i></div>
          <form id="searchForm" action="/admin/categorySearch">
            <div class="form-group">
              <input type="search" name="search" placeholder="What are you searching for...">
              <button type="submit" class="submit">Search</button>
            </div>
          </form>
        </div>
      </div> -->

      <div class="container-fluid d-flex align-items-center justify-content-between">
        <div class="navbar-header">
          <!-- Navbar Header--><a href="/admin/dashboard" class="navbar-brand">
            <div class="brand-text brand-big visible text-uppercase"><strong
                class="text-primary">TICKER</strong><strong>ADMIN</strong></div>
            <div class="brand-text brand-sm"><strong class="text-primary">T</strong><strong>A</strong></div>
          </a>
          <!-- Sidebar Toggle Btn-->
          <button class="sidebar-toggle"><i class="fa fa-long-arrow-left"></i></button>
        </div>

        <div class="right-menu list-inline no-margin-bottom ">
          <form id="searchForm" action="/admin/categorySearch">
            <div class="form-group d-flex">

              <input name="search" id="search" type="search" placeholder="What are you searching for..."
                class="mr-sm-3 form-control form-control">
              <button style="width: 90px;" type="submit" class="btn btn-primary">search</button>
            </div>
          </form>
        </div>
        <div class="right-menu list-inline no-margin-bottom">


          <!-- Log out               -->

          <div class="list-inline-item logout">


            <a href="/admin/logout" class="btn btn-dark btn-sm ">Logout<i class="icon-logout"></i></a>

          </div>

        </div>
      </div>
    </nav>
  </header>
  <div class="d-flex align-items-stretch">
    <!-- Sidebar Navigation-->
    <nav id="sidebar">
      <!-- Sidebar Header-->,

      <ul class="list-unstyled">
        <li><a href="/admin/dashboard"> <i class="icon-home"></i>Dashboard </a></li>
        <li><a href="/admin/product"> <i class=" icon icon-pencil-case"></i>Products</a></li>
        <li><a href="/admin/user"><i class="icon icon-user"></i>Users</a></li>
        <li><a href="/admin/category"> <i class="icon-layers"></i>Category</a></li>
        <li><a href="/admin/orderMgt"> <i class="icon-new-file"></i>Orders</a></li>

        <li><a href="/admin/couponMangement"> <i class="icon icon-check"></i>Coupon</a></li>

        <li class="active"><a href="#exampledropdownDropdown" aria-expanded="false" data-toggle="collapse"> <i
              class="icon-windows "></i>Offer</a>
          <ul id="exampledropdownDropdown" class="collapse list-unstyled ">
            <li class="active"> <a href="/admin/category-offers"> <i class="icon icon-light-bulb active"></i>Category
                offer</a></li>
            <li><a href="/admin/product-offers"> <i class="icon icon-light-bulb active"></i>Product Offers</a></li>
          </ul>
        </li>
        <li><a href="/admin/sales-report"> <i class="icon-page"></i>Sales Repoart</a></li>
        <!-- <li><a href=""> <i class="icon-layers"></i>Category</a></li>
        <li><a href=""> <i class="icon icon-picture"></i>Banner</a></li> -->
      </ul><!-- Sidebar Navidation Menus-->

    </nav>
    <!-- Sidebar Navigation end-->
    <div class="page-content">
      <!-- Page Header-->
      <div class="page-header no-margin-bottom ">
        <div class="container-fluid">
          <h2 class="h5 no-margin-bottom ">C a t e g o r y O f f e r</h2>
          <div class="block-body text-center d-flex justify-content-end">
            <button type="button" data-toggle="modal" data-target="#myModal" class="btn btn-primary">Add Offer</button>
            <!-- Modal-->
            <div id="myModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true"
              class="modal fade text-left">
              <div role="document" class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header"><strong id="exampleModalLabel" class="modal-title">Add Category
                      Offer</strong>
                    <button type="button" data-dismiss="modal" aria-label="Close" class="close"><span
                        aria-hidden="true">×</span></button>
                  </div>
                  <div class="modal-body">

                    <form action="/admin/add-category-offer" method="post" id="addCategoryOffer">



                      <div class="form-group">
                        <label>Select Categories</label>
                        <p id="categoryMessage" class="text-danger"></p>

                        <div class="col-sm-12">
                          <select name="account" class="form-control mb-3 mb-3">
                            <option selected disabled>choose Category Name</option>
                            <% for( let i=0; i < categoryData.length; i++ ) { %>
                              <option value="<%=categoryData[i].categoryName %>">
                                <%=categoryData[i].categoryName %>
                              </option>
                              <% } %>

                          </select>
                        </div>


                      </div>

                      <div class="form-group">
                        <label>Category offer</label>
                        <p id="offerMessage" class="text-danger"></p>
                        <input id="offer" name="offer" type="numbers" min="0" placeholder="Enter Offer offer"
                          class="form-control">
                      </div>

                      <div class="form-group">
                        <label>Validity</label>
                        <p id="validityMessage" class="text-danger"></p>
                        <input id="date" name="date" type="date" placeholder="Choose Validity " class="form-control">
                      </div>

                      <div class="modal-footer">
                        <span class="showMessage mr-5 text-danger" id="showMessage"></span>
                        <button type="button" data-dismiss="modal" class="btn btn-secondary">Close</button>
                        <button id="submitButton" type="submit" class="btn btn-primary">Save</button>
                      </div>
                    </form>
                  </div>

                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Breadcrumb-->
      <div class="container-fluid">
        <ul class="breadcrumb">
          <li class="breadcrumb-item"><a href="/admin/dashboard">Home</a></li>
          <li class="breadcrumb-item active">Category Offer </li>
        </ul>


        <!-- ---------------------table------------------------- -->
        <div class="col-lg-12">
          <div class="block">

            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>NO</th>
                    <th>Categ.Name</th>
                    <th>Offer</th>

                    <th>Start Date</th>
                    <th>DeadLine</th>

                    <th>Status</th>
                    <th>Edit</th>
                    <th>Delete</th>



                  </tr>
                </thead>
                <tbody>
                  <% if (offerData.length> 0){%>

                    <% for(let i=0 ; i <offerData.length ; i++){ %>
                      <tr>
                        <td>
                          <%= i + 1 %>
                        </td>
                        <td>
                          <%= offerData[i]?.categoryId?.categoryName %>
                        </td>
                        <td>
                          <%= offerData[i]?.offer %>
                        </td>
                        <td>
                          <%= new Date(offerData[i]?.createdAt).toLocaleDateString() %>
                        </td>
                        <td>
                          <%= new Date(offerData[i]?.validity).toLocaleDateString() %>
                        </td>


                        <td class="">
                          <% if (new Date(offerData[i]?.validity) < new Date()) { %>
                            <span class="text-danger"> Inactive </span>
                            <% } else { %>
                              <span class="text-success"> Active </span>
                              <% } %>
                        </td>
                        <th>
                          <div class="block-body text-center d-flex ">
                            <button type="button" data-toggle="modal" data-target="#editmyModal"
                              class="btn btn-outline-success icon icon-new-file btn-sm"
                              onclick="editCategoryOffer('<%= offerData[i]?._id %>','<%=offerData[i]?.categoryId?.categoryName%>','<%= offerData[i]?.offer%>','<%= offerData[i]?.validity%>')"></button>

                          </div>
                        </th>


                        <th>
                          <a class="btn btn-outline-danger icon icon-close btn-sm"
                            onclick="deleteOffer('<%=offerData[i]._id%>')"></a>
                        </th>
                      </tr>
                      <% } %>
                        <% } else { %>
                          <tr>
                            <td colspan="4">
                              <p class=" text-white fw-bolder">No category offer found in the database</p>
                            </td>
                          </tr>
                          <% } %>
                </tbody>
              </table>
            </div>
          </div>
          <div class="card-footer py-4 ">
            <nav aria-label="...">
              <ul class="pagination justify-content-center mb-0">
                <%if(currentPage>1){%>
                  <li class="page-item ">
                    <a class="page-link " href="?page=<%= currentPage - 1 %>" tabindex="-1">
                    </a>
                  </li>
                  <%}%>
                    <%for (let i=1;i<=totalPages;i++){%>
                      <%if(i==currentPage){%>
                        <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                          <a class="page-link" href="#">
                            <%=i%>
                          </a>


                        </li>
                        <% }else{ %>


                          <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                            <a class="page-link" href="?page=<%=i%>&search=<%=search%>">
                              <%=i%>
                            </a>
                          </li>
                          <%}%>
                            <%}%>
                              <% if(currentPage < totalPages){%>
                                <li class="page-item">
                                  <a class="page-link" href="?page=<%=totalPages%>&search=<%=search%>">></a>


                                </li>
                                <%}%>
              </ul>
            </nav>
          </div>
        </div>

        <!-- edit Modal-->
        <div id="editmyModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true"
          class="modal fade text-left">
          <div role="document" class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header"><strong id="exampleModalLabel" class="modal-title">Edit
                  offer</strong>
                <button type="button" data-dismiss="modal" aria-label="Close" class="close"><span
                    aria-hidden="true">×</span></button>
              </div>
              <div class="modal-body">
                <form action="" method="post" id="editCagtegoryOffer">

                  <div class="form-group">
                    <label>Select Categories</label>
                    <p id="categoryMessage" class="text-danger"></p>

                    <div class="col-sm-12">
                      <select id="selectCategoryName" name="account" class="form-control mb-3 mb-3">
                        <option selected disabled>choose Category Name</option>
                        <% for( let i=0; i < categoryData.length; i++ ) { %>
                          <option value="<%=categoryData[i].categoryName %>">
                            <%=categoryData[i].categoryName %>
                          </option>
                          <% } %>

                      </select>
                    </div>
                  </div>
                  <div class="form-group">
                    <label>Category offer</label>
                    <p id="offerMessage" class="text-danger"></p>
                    <input id="editCategoryOffer" name="offer" type="numbers" min="0" placeholder="Enter Offer offer"
                      class="form-control">
                  </div>

                  <div class="form-group">
                    <label>Validity</label>
                    <p id="validityMessage" class="text-danger"></p>
                    <input id="editCategoryValidity" name="date" type="date" class="form-control">
                  </div>

                  <input id="offerid" name="offerId" type="text" min="0" class="form-control" value="<%=offerData._id%>"
                    hidden>

                  <div class="modal-footer">
                    <span class="showMessage mr-5 text-danger" id="showMessage"></span>
                    <button type="button" data-dismiss="modal" class="btn btn-secondary">Close</button>
                    <button id="editSubmitButton" type="submit" class="btn btn-primary">Save Changes</button>
                  </div>
                </form>
              </div>

            </div>
          </div>
        </div>


      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>
    <script>


      function editCategoryOffer(offerId, categoryName, offer, validity) {

        // Set the offer ID and name in the modal inputs
        document.getElementById('offerid').value = offerId
        document.getElementById('editCategoryOffer').value = offer;
        //document.getElementById('editCategoryValidity').value = new Date(validity).toLocaleDateString();
        document.getElementById('selectCategoryName').value = categoryName;

        if (validity) {
          const date = new Date(validity);
          const formattedDate = date.toISOString().split('T')[0]; // Converts to YYYY-MM-DD

          document.getElementById('editCategoryValidity').value = formattedDate;
        }
        // Show the modal
        $('#editmyModal').modal('show');
      }





      document.getElementById('addCategoryOffer').addEventListener('submit', async function (event) {
        event.preventDefault();

        const categorySelect = document.querySelector('select[name="account"]');
        const offerInput = document.getElementById('offer');
        const dateInput = document.getElementById('date');
        const numberRegex = /^[0-9]+$/;
        const today = new Date().toISOString().split('T')[0];
        let isValid = true;

        // Validate product selection
        if (categorySelect.value === 'choose Category Name' || categorySelect.value === '') {
          document.getElementById('categoryMessage').textContent = 'Please choose a product.';
          isValid = false;
        } else {
          document.getElementById('categoryMessage').textContent = '';
        }

        // Validate offer input
        if (!numberRegex.test(offerInput.value) || offerInput.value < 5 || offerInput.value > 60) {
          document.getElementById('offerMessage').textContent = 'Please enter a valid offer between 5 to 60.';
          isValid = false;
        } else {
          document.getElementById('offerMessage').textContent = '';
        }

        // Validate date input
        if (dateInput.value === '' || dateInput.value < today) {
          document.getElementById('validityMessage').textContent = 'Please choose a validity date.';
          isValid = false;
        } else {
          document.getElementById('validityMessage').textContent = '';
        }

        if (isValid) {
          const formData = {
            category: categorySelect.value,
            offer: offerInput.value,
            validity: dateInput.value
          };

          try {

            const response = await fetch("/admin/add-category-offers", {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(formData)
            });

            const data = await response.json();

            if (data.success) {
              Swal.fire({
                icon: 'success',
                title: data.message,
                showConfirmButton: false,
                timer: 1000,
                toast: true,
                position: 'top-end'
              })
                .then(() => { window.location.href = '/admin/category-offers' })
            } else {
              Swal.fire({
                icon: 'error',
                title: data.message,
                showConfirmButton: false,
                timer: 1000,
                toast: true,
                position: 'top-end'
              })
            }
          } catch (error) {

            Swal.fire({
              icon: 'error',
              title: 'something went wrong . Please try again',
              showConfirmButton: false,
              timer: 1000,
              toast: true,
              position: 'top-end'
            })
          }
        }


      });



      document.getElementById('editCagtegoryOffer').addEventListener('submit', async function (event) {
        event.preventDefault();
        const offerId = document.getElementById('offerid').value
        const offer = document.getElementById('editCategoryOffer')
        const categoryName = document.getElementById('selectCategoryName')
        const validity = document.getElementById('editCategoryValidity')
        let isValid = true;

        // Validate product selection
        if (categoryName.value === 'choose product Name' || categoryName.value === '') {
          document.getElementById('categoryMessage').textContent = 'Please choose a product.';
          isValid = false;
        } else {
          document.getElementById('categoryMessage').textContent = '';
        }

        // Validate offer input
        if (offer.value === '' || offer.value <= 0) {
          document.getElementById('offerMessage').textContent = 'Please enter a valid offer.';
          isValid = false;
        } else {
          document.getElementById('offerMessage').textContent = '';
        }

        // Validate date input
        if (validity.value === '') {
          document.getElementById('validityMessage').textContent = 'Please choose a validity date.';
          isValid = false;
        } else {
          document.getElementById('validityMessage').textContent = '';
        }

        if (!isValid) {
          return;
        }


        const editformData = {
          offerId,
          offer: offer.value,
          categoryName: categoryName.value,
          validity: validity.value,
        }


        try {

          const response = await fetch("/admin/edit-category-offer", {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(editformData)
          });

          const data = await response.json();

          if (data.success) {
            Swal.fire({
              icon: 'success',
              title: data.message,
              showConfirmButton: false,
              timer: 1000,
              toast: true,
              position: 'top-end'
            }).then(() => { window.location.href = '/admin/category-offers' })
          } else {
            Swal.fire({
              icon: 'error',
              title: data.message,
              showConfirmButton: false,
              timer: 1000,
              toast: true,
              position: 'top-end'
            })
          }
        } catch (error) {
          console.log(error.message);
          Swal.fire({
            icon: 'error',
            title: 'something went wrong . Please try again',
            showConfirmButton: false,
            timer: 1000,
            toast: true,
            position: 'top-end'
          })
        }
      });



    </script>

    <script>
      // function changeStatus(couponId) {
      //   return Swal.fire({
      //     title: "Are you sure you want to unlist this offer?",
      //     text: "This action cannot be undone.",
      //     icon: "warning",
      //     toast: true,
      //     showCancelButton: true,
      //     confirmButtonColor: "#d33",
      //     cancelButtonColor: "#1eba0a",
      //     confirmButtonText: "Yes, unlist it!",
      //   }).then(async (result) => {
      //     if (result.isConfirmed) {
      //       console.log(result, "this")
      //       try {
      //         // Make AJAX request to backend
      //         const response = await fetch(`/admin/status-offer`, {
      //           method: "PUT",
      //           headers: {
      //             "Content-Type": "application/json",
      //           },
      //           body: JSON.stringify({ couponId })
      //         })

      //         const data = await response.json();
      //         if (data.success) {
      //           Swal.fire({
      //             icon: 'success',
      //             title: data.message,
      //             showConfirmButton: false,
      //             timer: 1000,
      //             toast: true,
      //             position: 'top-end'
      //           }).then(() => {
      //             window.location.reload()
      //           })
      //         } else {
      //           Swal.fire({
      //             icon: 'error',
      //             title: data.message,
      //             showConfirmButton: false,
      //             timer: 1000,
      //             toast: true,
      //             position: 'top-end'
      //           })
      //         }
      //       } catch (error) {
      //         console.log(error.message);
      //       }
      //     }
      //   });
      // }
      //delete offer
      function deleteOffer(offerId) {

        return Swal.fire({
          title: "Are you sure you want to delete this offer?",
          icon: "question",
          toast: true,
          showCancelButton: true,
          confirmButtonColor: "#1eba0a",
          cancelButtonColor: "#d33",
          confirmButtonText: "Yes, Delete it!",
        }).then(async (result) => {
          if (result.isConfirmed) {
            // Make AJAX request to backend
            try {

              const response = await fetch(`/admin/delete-category-offer?offerId=${offerId}`, {
                method: "DELETE",
                headers: {
                  "Content-Type": "application/json",
                },
                // body: JSON.stringify({ categoryId }), 
              })
              const data = await response.json();

              if (data.success) {
                Swal.fire({
                  icon: 'success',
                  title: data.message,
                  showConfirmButton: false,
                  timer: 1000,
                  toast: true,
                  position: 'top-end'
                }).then(() => {
                  window.location.reload()
                })
              } else {
                Swal.fire({
                  icon: 'error',
                  title: data.message,
                  showConfirmButton: false,
                  timer: 1000,
                  toast: true,
                  position: 'top-end'
                })
              }
            } catch (error) {
              console.log(error.message)
            }

          }
        });
      }
    </script>

    </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- JavaScript files-->
    <script src="/admin/vendor/jquery/jquery.min.js"></script>
    <script src="/admin/vendor/popper.js/umd/popper-utils.min.js"> </script>
    <script src="/admin/vendor/bootstrap/js/bootstrap.min.js"></script>
    <script src="/admin/vendor/jquery.cookie/jquery.cookie.js"> </script>
    <script src="/admin/vendor/chart.js/Chart.min.js"></script>
    <script src="/admin/vendor/jquery-validation/jquery.validate.min.js"></script>
    <script src="/admin/js/front.js"></script>
</body>

</html>