<!DOCTYPE html>
<html lang="en">
<meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="ticker">
  <title>Ticker</title>

  <!-- SLIDER REVOLUTION 4.x CSS SETTINGS -->
  <link rel="stylesheet" type="text/css" href="/user/rs-plugin/settings.css" media="screen" />

  <!-- Bootstrap Core CSS -->
  <link href="/user/css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom CSS -->
  <link href="/user/css/font-awesome.min.css" rel="stylesheet" type="text/css">
  <link href="/user/css/ionicons.min.css" rel="stylesheet">
  <link href="/user/css/main.css" rel="stylesheet">
  <link href="/user/css/style.css" rel="stylesheet">
  <link href="/user/css/responsive.css" rel="stylesheet">
  <link href="/user/font/flaticon.css" rel="stylesheet">

  <!-- JavaScripts -->
  <script src="/user/js/modernizr.js"></script>

  <!-- Online Fonts -->
  <link
    href="https://fonts.googleapis.com/css?family=Merriweather:300,400,700,900|Poppins:300,400,500,600,700|Montserrat:300,400,500,600,700,800"
    rel="stylesheet">

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.12/dist/sweetalert2.min.css">


</head>

<body>

  <!-- LOADER -->
  <div id="loader">
    <div class="position-center-center">
      <div class="ldr"></div>
    </div>
  </div>

  <!-- Wrap -->
  <div id="wrap">

    <!-- TOP Bar -->
    <div class="top-bar">
      <div class="container-full">
        <p><i class="icon-envelope"></i> Info@TickerShop.com </p>
        <p class="call"> <i class="icon-call-in"></i> 001 234 7895 </p>

        <!-- Login Info -->
        <div class="login-info">
          <ul>

            <% if (!userId) { %>
              <li><a href="/login">LOGIN</a></li>
              <% }else{%>
                <li><a href="/user/profile">MY ACCOUNT </a></li>
                <%} %>
                  <li><a href="/wishlist">WISHLIST</a></li>
                  <li><a id="Count" href="/cart">CART<i class="icon-basket-loaded"></i> <span
                        class="cart-count badge badge-danger text-white"></span></a></li>


          </ul>
        </div>
      </div>
    </div>

    <!-- header -->
    <header>
      <div class="sticky">
        <div class="container-full d-flex justify-content-between ">

          <!-- Logo -->
          <div class="logo"> <a href="/"><img class="img-responsive w-25 h-10" src="/image/logo.png" alt=""></a> </div>


          <div class=" mr-5 pr-5">
            <!-- <form id="searchForm" action=""  class="search-form"> -->

            <div class="input-group flex-nowrap">
              <input id="searchInput" class="input-group__field  w-100  border " type="search" name="search"
                placeholder="Search" aria-label="search">
              <button id="searchButton" class="btn rounded-end px-3 text-nowrap " type="submit"><i
                  class="icon-magnifier "></i></button>
            </div>
            <!-- </form> -->
          </div>

          <nav class="navbar ownmenu navbar-expand-lg ml-5 ">
            <button class="navbar-toggler collapsed" type="button" data-toggle="collapse" data-target="#navbarNav"
              aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span></span> </button>
            <div class="collapse navbar-collapse" id="navbarNav">
              <div class="collapse navbar-collapse" id="navbarNav">
                <nav class="header__menu mobile-menu">
                  <ul>
                    <li class="active"><a href="/">Home</a></li>
                    <li><a href="/shop">Shop</a></li>
                  </ul>
                </nav>
              </div>
            </div>
          </nav>
        </div>
      </div>
      <div class="clearfix"></div>
    </header>

    <!-- Content -->
    <div id="content">

      <!-- SUB BANNER -->
      <section class="sub-bnr" data-stellar-background-ratio="0.5">
        <div class="position-center-center">
          <div class="container">
            <h4>Shopping Cart</h4>
            <ol class="breadcrumb">
              <li><a href="/">Home</a></li>
              <li><a href="/shop">Shop</a></li>
              <li class="active">Shopping Cart</li>
            </ol>
          </div>
        </div>
      </section>
      <% let total %>
        <% if(cartProduct.length==0){%>
          <div class="d-flex align-items-center justify-content-center mb-5 mt-5">
            <div class="">
              <h4 class="fw-bold">CART IS EMPTY</h4>
              <br>
              <a href="/shop" class="btn btn-primary border">Continue Shop</a>
            </div>
          </div>
          <%}else{%>
            <!-- PAGES INNER -->
            <section class="padding-top-40 padding-bottom-20 pages-in chart-page">
              <div class="container">

                <!-- Payments Steps -->
                <div class="shopping-cart text-center">
                  <table class="table">
                    <thead class="thead-dark">
                      <tr>
                        <th scope="col" class="text-left">Items</th>
                        <th scope="col">Price</th>
                        <th scope="col">Qty</th>
                        <th scope="col">Total</th>
                        <th scope="col">Remove</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% for(let i=0 ; i<cartProduct.length ; i++){ %>

                        <tr id="cart-row-<%= cartProduct[i].products.productId %>">

                          <th class="text-left"> <!-- Media Image -->
                            <a class="item-img"> <img class="media-object w-75"
                                src="<%= cartProduct[i].productDetails[0].image[0] %>" alt=""> </a>

                            <!-- Item Name -->
                            <div class="media-body fs-4 mt-4">
                              <a href="/product?id=<%=cartProduct[i].productDetails[0]._id%>">
                                <%=cartProduct[i].productDetails[0].name %>
                              </a>
                              <p></p>
                            </div>
                          </th>
                          <td id="product-price">
                            <% if (cartProduct[i].productDetails[0].offerPrice) { %>
                              <span class="price"><small>₹</small>
                                <%=cartProduct[i].productDetails[0].offerPrice %>
                              </span>
                              <% }else{%>
                                <span class="price"><small>₹ </small>
                                  <%=cartProduct[i].productDetails[0].mrp %>
                                </span>
                                <%} %>
                          </td>
                          <td>
                            <div class="quantity">

                              <input id="quantity<%=i%>" name="quantity" type="number" min="1"
                                max="<%=(cartProduct[i].productDetails[0].stock >= 5) ? 5 : cartProduct[i].productDetails[0].stock %>"
                                step="1" readonly class="form-control qty"
                                value="<%=cartProduct[i].products.quantity%>">
                              <div class="quantity-nav">
                                <div class="quantity-button quantity-up" id="up-button"
                                  onclick="increment('<%=cartProduct[i].products._id%>','<%=cartProduct[i].productDetails[0].offerPrice? cartProduct[i].productDetails[0].offerPrice : cartProduct[i].productDetails[0].mrp%>','<%=cartProduct[i].productDetails[0].stock%>','<%=i%>','<%= cartProduct[i].products.productId %>')">
                                  <i id="upp" class="fa fa-caret-up" ::before></i>
                                </div>
                                <% if (cartProduct[i].productDetails[0].stock>0) { %>
                                  <div class="quantity-button quantity-down" id="down-button"
                                    onclick="decrement('<%=cartProduct[i].products._id%>','<%=cartProduct[i].productDetails[0].offerPrice? cartProduct[i].productDetails[0].offerPrice : cartProduct[i].productDetails[0].mrp%>','<%=cartProduct[i].productDetails[0].stock%>','<%=i%>','<%= cartProduct[i].products.productId %>')">
                                    <i class="fa fa-caret-down" ::before></i>
                                  </div>
                                  <% } else if (cartProduct[i].productDetails[0].stock===0){ %>
                                    <span class="d-block mt-2 text-danger">out of stock &#128542;</span>
                                    <% } %>
                              </div>
                            </div>
                            <%if(cartProduct[i].productDetails[0].stock<=5){%>
                              <strong class="d-block mt-2   text-danger fw-bold">stock:
                                <%=cartProduct[i].productDetails[0].stock%>
                              </strong>
                              <%}else{%>
                                <span></span>
                                <%}%>
                          </td>
                          <td class="item-total" id="total<%=i%>"><span class="price"><small>₹</small>
                              <%= (cartProduct[i].productDetails[0].offerPrice?
                                cartProduct[i].productDetails[0].offerPrice : cartProduct[i].productDetails[0].mrp )*
                                cartProduct[i].products.quantity %>
                            </span></td>
                          <td><i class="icon-close"
                              onclick="remove('<%= cartProduct[i].products.productId %>')"></i></a>
                          </td>
                        </tr>
                        <% } %>
                    </tbody>
                  </table>
                </div>
              </div>
            </section>

            <!-- PAGES INNER -->
            <section class="padding-top-10 padding-bottom-100 light-gray-bg shopping-cart small-cart d-flex">
              <div class="container">

                <!-- SHOPPING INFORMATION -->
                <div class="cart-ship-info margin-top-0 ">
                  <div class="row">

                    <!-- DISCOUNT CODE -->
                    <div class="col-sm-7">
                      <div class="coupn-btn"> <a href="/shop" class="btn ">continue shopping</a> </div>
                    </div>
                    <!-- <a href="#." class="btn ">Clearcart</a>  -->
                    <!-- SUB TOTAL -->
                    <div class="col-sm-5">
                      <h6>Grand Total</h6>
                      <div class="grand-total">
                        <div class="order-detail">

                          <% for(let i=0 ; i<cartProduct.length ; i++){ %>

                            <p id="item-summary-<%= cartProduct[i].products.productId %>">
                              <%=cartProduct[i].productDetails[0].name %>
                                <span id="item-total-<%= cartProduct[i].products.productId %>"
                                  class="text-primary bold">₹
                                  <%= (cartProduct[i].productDetails[0].offerPrice?
                                    cartProduct[i].productDetails[0].offerPrice : cartProduct[i].productDetails[0].mrp)
                                    * cartProduct[i].products.quantity %>
                                </span>
                            </p>

                            <% total=cartProduct[i].totalCost %>
                              <%}%>
                                <div id="delivery-msg">
                                  <p id="delivery-text"
                                    class="<%= totalCost < 2500 ? 'text-danger' : 'text-success' %> text-center font-weight-light">
                                    <%= totalCost < 2500 ? 'Free delivery available above RS:2500'
                                      : 'Free delivery available' %>
                                  </p>
                                </div>
                                <!-- SUB TOTAL -->
                                <p id="totalCost" class="all-total">TOTAL COST: <span><small>₹</small>

                                    <%=total %>

                                  </span></p>
                        </div>
                        <a id="proceedBtn" class="btn btn-primary margin-top-20 text-white px-3 w-100 w-md-auto">
                          Proceed to checkout
                        </a>

                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </section>
            <%} %>
    </div>

    <!-- FOOTER -->
    <footer>
      <div class="container">
        <div class="row">
          <!-- ABOUT Location -->
          <div class="col-md-4">
            <div class="about-footer"> <img class="margin-bottom-30 w-25 h-25" src="/image/logo.png" alt="">
              <p><i class="icon-pointer"></i> Street No. 12, Newyork 12, <br>
                MD - 123, USA.</p>
              <p><i class="icon-call-end"></i> 1.800.123.456789 <br>
                1.800.123.456789</p>
              <p><i class="icon-envelope"></i> info@TickerShop.com <br>
                contact@TickerShop.com</p>
            </div>
          </div>

          <!-- HELPFUL LINKS -->
          <div class="col-md-5">
            <h6>Links</h6>
            <ul class="link two-half">
              <li><a href="#."> Products</a></li>
              <li><a href="#."> Find a Store</a></li>
              <li><a href="#."> Features</a></li>
              <li><a href="#."> Privacy Policy</a></li>
              <li><a href="#."> Blog</a></li>
              <li><a href="#."> Press Kit </a></li>
              <li><a href="#."> Products</a></li>
              <li><a href="#."> Find a Store</a></li>
              <li><a href="#."> Features</a></li>
              <li><a href="#."> Privacy Policy</a></li>
              <li><a href="#."> Blog</a></li>
              <li><a href="#."> Press Kit </a></li>
            </ul>
          </div>

          <!-- HELPFUL LINKS -->
          <div class="col-md-3">
            <h6>Account Info</h6>
            <ul class="link">
              <li><a href="#."> Products</a></li>
              <li><a href="#."> Find a Store</a></li>
              <li><a href="#."> Features</a></li>
              <li><a href="#."> Privacy Policy</a></li>
              <li><a href="#."> Blog</a></li>
              <li><a href="#."> Press Kit </a></li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Rights -->
      <div class="rights">
        <div class="container">
          <div class="row">
            <div class="col-md-6">
              <p>© TickerShops All right reserved. <a href="https://webicode.com/">webicode</a></p>
            </div>
            <div class="col-md-6 text-right"> <img src="" alt=""> </div>
          </div>
        </div>
      </div>
    </footer>
  </div>
  <script src="/user/js/jquery-1.12.4.min.js"></script>
  <script src="/user/js/popper.min.js"></script>
  <script src="/user/js/bootstrap.min.js"></script>
  <script src="/user/js/own-menu.js"></script>
  <script src="/user/js/jquery.lighter.js"></script>
  <script src="/user/js/jquery.magnific-popup.min.js"></script>
  <script src="/user/js/owl.carousel.min.js"></script>
  <script src="/user/js/main.js"></script>
  <script src="/user/js/toast.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.12/dist/sweetalert2.min.js"></script>

  <script>
    //search option
    const fetchFilteredProducts = async () => {
      try {

        const searchQuery = document.getElementById('searchInput').value.trim();


        const queryParams = new URLSearchParams({
          search: searchQuery,

        });


        window.location.href = `/shop?${queryParams}`;

      } catch (error) {
        console.error('Error filtered products:', error);
      }
    };

    // Call the fetchFilteredProducts function whenever filter btn clicks 
    document.getElementById('searchButton').addEventListener('click', fetchFilteredProducts)
    function recalculateCartTotal() {
      let total = 0;

      // All remaining product total spans in cart table
      document.querySelectorAll(".item-total span").forEach(el => {
        const priceText = el.textContent.replace(/[₹\s]/g, '');
        const amount = parseFloat(priceText);
        if (!isNaN(amount)) total += amount;
      });

      // Update total cost
      const totalCostEl = document.querySelector("#totalCost span");
      if (totalCostEl) {
        totalCostEl.innerHTML = `<small>₹</small> ${total.toFixed(2)}`;
      }

      // Update delivery message
      const deliveryMsg = document.getElementById("delivery-text");
      if (deliveryMsg) {
        if (total < 2500) {
          deliveryMsg.textContent = "Free delivery available above RS:2500";
          deliveryMsg.className = "text-danger text-center font-weight-light";
        } else {
          deliveryMsg.textContent = "Free delivery available";
          deliveryMsg.className = "text-success text-center font-weight-light";
        }
      }
    }


    //product remove form cart 
    async function remove(productId) {

      try {
        const confirmation = await Swal.fire({
          title: "Are you sure?",
          text: "You won't be able to revert this!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "Yes, delete it!"
        })

        if (confirmation.isConfirmed) {
          const response = await axios.delete('/cart/remove', { data: { productId } })
          if (response.data.success) {
            const row = document.getElementById(`cart-row-${productId}`);
            if (row) {
              row.remove();
            }

            const summary = document.getElementById(`item-summary-${productId}`);
            if (summary) summary.remove();

            // Recalculate the total
            recalculateCartTotal();

            await showToast({
              icon: 'success',
              title: response.data.message,
            })


          } else {
            await showToast({
              icon: 'error',
              title: response.data.message,
            });
          }
        }

      } catch (error) {
        console.log("Remove Error:", error.message);
      }
    }


    function recalculateCartTotal() {
      let total = 0;

      // All remaining product total spans in cart table
      document.querySelectorAll(".item-total span").forEach(el => {
        const priceText = el.textContent.replace(/[₹\s]/g, '');
        const amount = parseFloat(priceText);
        if (!isNaN(amount)) total += amount;
      });

      // Update total cost
      const totalCostEl = document.querySelector("#totalCost span");
      if (totalCostEl) {
        totalCostEl.innerHTML = `<small>₹</small> ${total.toFixed(2)}`;
      }

      // Update delivery message
      const deliveryMsg = document.getElementById("delivery-text");
      if (deliveryMsg) {
        if (total < 2500) {
          deliveryMsg.textContent = "Free delivery available above RS:2500";
          deliveryMsg.className = "text-danger text-center font-weight-light";
        } else {
          deliveryMsg.textContent = "Free delivery available";
          deliveryMsg.className = "text-success text-center font-weight-light";
        }
      }
    }
    let isIncrementing = false;
    let isDecrementing = false;

    async function increment(cartItemId, mrp, stock, index, productId) {
      // Validate productId is passed from onclick
      if (isIncrementing) return; // prevent multiple clicks
      isIncrementing = true;
      try {
        let quantityInput = document.getElementById(`quantity${index}`);
        let quantity = parseInt(quantityInput.value);

        if (quantity >= stock) {
          await Swal.fire({ icon: "info", title: "Oops", text: "Maximum quantity reached", timer: 1500, toast: true, showConfirmButton: false });
          return;
        }

        const response = await axios.patch("/cart/increment", { cartItemId });

        if (response.data.success) {
          const totalAmount = mrp * (quantity + 1);
          document.getElementById(`quantity${index}`).value = quantity + 1;

          // Update individual row total
          document.getElementById(`total${index}`).innerHTML = `<span class='price'><small>₹</small>${totalAmount}</span>`;

          // Update grand total item amount
          const totalSpan = document.getElementById(`item-total-${productId}`);
          if (totalSpan) totalSpan.innerHTML = `₹${totalAmount}`;

          // Recalculate totalCost and delivery message
          recalculateCartTotal();
        }

      } catch (error) {
        console.log(error.message);
        Swal.fire({ icon: "error", title: "Error", text: "Something went wrong", toast: true, timer: 1500 });
      } finally {
        isIncrementing = false;
      }
    }

    async function decrement(cartItemId, mrp, stock, index, productId) {
      try {
        if (isDecrementing) return; // prevent multiple clicks
        isDecrementing = true;
        const quantityInput = document.getElementById(`quantity${index}`);
        let quantity = parseInt(quantityInput.value);

        if (quantity <= 1) {
          await Swal.fire({
            icon: 'info',
            title: 'Oops...',
            text: 'Minimum quantity reached',
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 1500
          });
          return; // Stop execution
        }

        const response = await axios.patch("/cart/decrement", { cartItemId });

        if (response.data.success) {
          const newQuantity = quantity - 1;
          const totalAmount = mrp * newQuantity;

          // Update quantity input field
          quantityInput.value = newQuantity;

          // Update per-item total in cart table
          const itemTotal = document.getElementById(`total${index}`);
          if (itemTotal)
            itemTotal.innerHTML = `<span class='price'><small>₹</small>${totalAmount}</span>`;

          // Update grand total section per-item total
          const itemTotalDown = document.getElementById(`item-total-${productId}`);
          if (itemTotalDown)
            itemTotalDown.innerHTML = `₹${totalAmount}`;

          // Recalculate grand total
          recalculateCartTotal(); // Make sure this utility is defined

        } else {
          await Swal.fire({
            icon: 'error',
            title: 'Error',
            text: response.data.message || 'Failed to decrease the product',
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 1500
          });
        }

      } catch (error) {
        console.log(error.message);
        Swal.fire({
          icon: 'error',
          text: "Something went wrong",
          toast: true,
          position: 'top-end',
          showConfirmButton: false,
          timer: 1500
        });
      } finally {
        isDecrementing = false; // unlock
      }
    }

    document.getElementById('proceedBtn')?.addEventListener('click', async () => {

      try {
        const response = await axios.get("/cart/check");

        if (response.data.success) {
          await Swal.fire({
            toast: true,
            position: 'top-end',
            icon: 'success',
            title: 'Proceeding to checkout',
            showConfirmButton: false,
            timer: 500
          }).then(() => {
            window.location.href = '/checkout'
          })
        } else {
          await Swal.fire({
            toast: true,
            position: 'top-end',
            icon: 'error',
            title: response.data.message,
            showConfirmButton: false,
            timer: 1500
          })
        }
      } catch (error) {
        console.log('Error:', error.message);
        await Swal.fire({
          toast: true,
          position: 'top-end',
          icon: 'error',
          title: 'An unexpected error occurred. Please try again later.',
          showConfirmButton: false,
          timer: 3000
        });
      }
    });
  </script>

</body>

</html>