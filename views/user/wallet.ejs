<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TICKER</title>



    <link rel="icon" type="image/png" href="/image/download.png" />

    <link rel="stylesheet" type="text/css" href="/profile/util.css">
    <!-- <link rel="stylesheet" type="text/css" href="/profile/main.css"> -->

    <link rel="stylesheet" type="text/css" href="/profile/userProfile.css">
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css'>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">


</head>

<body>

    <div class="mt-5">
        <section class="breadcrumb-option">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="breadcrumb__text">
                            <h5>Address management</h5>
                            <div class="breadcrumb__links">
                                <a href="/" class="text-dark text-decoration-none">Home</a>
                                <span>></span>

                                <a href="/user/profile" class="text-dark text-decoration-none">profile</a>
                                <span>></span>
                                <span>Address</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>



    <div class="container">
        <div class="main-body">
            <div class="bg0 p-t-30 p-b-75">

                <div class="row">
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex flex-column align-items-center text-center">
                                     <svg version="1.1"
                                        width="50" height="50"
                                         id="Layer_1"
                                          xmlns="http://www.w3.org/2000/svg"
                                           x="0" y="0" viewBox="0 0 32 32" 
                                           style="enable-background:new 0 0 32 32" 
                                           xml:space="preserve">
                                           <style>.st1{fill:#333}
                                            
                                           </style>
                                           <path class="st1" 
                                           d="M25.838 31H6.162a3.957 3.957 0 0 1-3.245-1.661 3.956 3.956 0 0 1-.549-3.604l.704-2.113a6.034 6.034 0 0 1 4.966-4.059C10.131 19.307 13.211 19 16 19c2.788 0 5.869.307 7.963.563a6.032 6.032 0 0 1 4.965 4.059l.704 2.113a3.954 3.954 0 0 1-.55 3.604A3.955 3.955 0 0 1 25.838 31zM16 21c-2.688 0-5.681.298-7.718.549a4.02 4.02 0 0 0-3.312 2.706l-.704 2.112c-.206.618-.106 1.274.274 1.802S5.511 29 6.162 29h19.676a1.98 1.98 0 0 0 1.622-.83c.381-.528.48-1.185.275-1.803l-.704-2.112a4.02 4.02 0 0 0-3.312-2.706C21.681 21.298 18.687 21 16 21zM16 18c-4.687 0-8.5-3.813-8.5-8.5S11.313 1 16 1c4.687 0 8.5 3.813 8.5 8.5S20.687 18 16 18zm0-15c-3.584 0-6.5 2.916-6.5 6.5S12.416 16 16 16s6.5-2.916 6.5-6.5S19.584 3 16 3z"/>
                                           <path d="M12.04 10.54c-.543 0-.988-.435-1-.98a4.964 4.964 0 0 1 1.394-3.564 4.968 4.968 0 0 1 3.505-1.535c.562.01 1.009.428 1.02.98a1 1 0 0 1-.98 1.02 2.982 2.982 0 0 0-2.103.92 2.981 2.981 0 0 0-.836 2.139 1 1 0 0 1-.98 1.02h-.02z" 
                                           style="fill:#ffb77d"/></svg>
									<div class="mt-3">
									
                                        <!-- <p class="text-secondary mb-1"></p>
									<p class="text-muted font-size-sm"></p>
									<button class="btn btn-primary">Follow</button>
									<button class="btn btn-outline-primary">Message</button> -->
                                    </div>
                                </div>
                                <hr class="my-4">
                                <ul class="list-group list-group-flush align-items-center">
                                    <li class="list-group-item " style="width: 310px;">
                                        <a href="/user/profile"> <button type="button" class="btn btn-outline-dark"
                                                style="width: 280px;">User Profile</button> </a>
                                    </li>
                                    <li class="list-group-item " style="width: 310px;">
                                        <a href="/user/address"> <button type="button" class="btn btn-outline-dark "
                                                style="width: 280px;">Address Management</button> </a>
                                    </li>
                                    <li class="list-group-item " style="width: 310px;">
                                        <a href="/user/changePass"> <button type="button" class="btn btn-outline-dark"
                                                style="width: 280px;">Change Password</button> </a>
                                    </li>

                                    <li class="list-group-item " style="width: 310px;">
                                        <a href="/user/order"> <button type="button" class="btn btn-outline-dark"
                                                style="width: 280px;">Order</button> </a>
                                    </li>

                                    <li class="list-group-item " style="width: 310px;">
                                        <a href="/user/wallet"> <button type="button"
                                                class="btn btn-outline-dark active"
                                                style="width: 280px;">Wallet</button> </a>
                                    </li>
                                  
                                    <li class="list-group-item " style="width: 310px;">
                                        <a href="/logout"> <button type="button" class="btn btn-outline-dark"
                                                style="width: 280px;">Logout</button> </a>
                                    </li>



                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="card mb-2   ml-4  col-lg-7 h-100">
                        <div class="card-header text-dark fw-bolder text-center mb-2">WALLET</div>
                        <!-- <div class="card-body "> -->
                        <div class="row">
                            <div class="col-md-6 d-flex flex-column align-items-stretch">
                                <div class="card flex-grow-1">
                                    <div class="card-body">
                                        <p class="text-dark fw-bolder ">BALANCE:<span class="text-success fw-bolder  "> &#8377;<%= walletData[0] ? walletData[0]?.balance?.toFixed(1) : 0 %></span>

                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6 d-flex flex-column  align-items-stretch">
                                <div class="card flex-grow-1">
                                    <div class="card-body">
                                        <form action="" id="amountForm">
                                            <div class="form-group   d-flex ">

                                                <input type="number" class="form-control col-lg-6" id="moneyInput"
                                                    placeholder="Enter Amount" min="0" max="10000" maxlength="5"
                                                    minlength="1">

                                                <button id="addMoneyBtn" type="submit"
                                                    class="btn btn-success  col-lg-6">Topup</button>



                                                <!-- <button onclick="withdrawMoney()" id="withdraw" type="submit" class="btn btn-danger  col-lg-3">cash out</button> -->
                                            </div>
                                        </form>
                                        <p id="moneyInputMessage" class="text-danger"></p>
                                    </div>

                                </div>
                            </div>

                            <!-- <div class="container">
            <div class="cardc d-flex">
                <div class="card-body col-lg-6">
                    POPDDGJAPSHJG
                </div>
                <div class="card-header col-lg-6 d-flex ">
                    <input type="password" class="form-control col-lg-8" id="inputPassword2" placeholder="Password">
                    <button class="btn btn-success ">
                        Add Money
                    </button>

                </div>
            </div> -->
                        </div>
                        <!-- </div> -->
                        <div class="card-header text-dark fw-bolder text-center mb-2">WALLET HISTORY</div>
                        <div class="col-lg-12  d-flex  align-items-stretch">
                        
                            <div class="card flex-grow-1">
                                <% if (walletData.length>0) { %>
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th scope="col " class="text-center fw-bolder">Date</th>
                                                <th scope="col " class="text-center fw-bolder">Amount</th>
    
                                                <th scope="col " class="text-center fw-bolder">Details</th>
                                                
                                            </tr>
                                        </thead>
    
                                        
                                        <tbody>
                                           
                                                <% for( let i = 0; i < walletData.length; i++ ) { %>
                                                
                                                   
                                                <tr>
                                                    <td class="text-center fw-bolder"><%=new Date(walletData[i]?.history?.createTime).toLocaleString("en-US") %></td>
                                                    <% if (walletData[i].history.transactionType=="Credit") { %>
                                                        <td class="text-center fw-bolder text-success ">+<%=walletData[i]?.history?.amount?.toFixed(1)%></td>
                                                    <% }else{%>
                                                        <td class="text-center fw-bolder text-danger">-<%=walletData[i]?.history?.amount?.toFixed(1)%></td>
                                                        <%} %>
                                                   
                                                    <td class="text-center fw-bolder "><%=walletData[i]?.history?.discription%></td>
                                                   
        
                                                </tr>
                                            <% } %>
                                           
    
                                        </tbody>
    
                                    </table>
                                <% }else{%>

                                    <p class="text-dark fw-bold text-center"> Wallet History Data Not Found  &#128528;</p>
                                    <%} %>
                               
                                <!-- <div class="card-body"><
                               
                            </div> -->
                            
                            <nav aria-label="Page navigation example" class="ml-4">
                              
                                <ul class="pagination">
                                  <% if (currentPage>1) { %>
                                 <li class="page-item">
                                    <a class="page-link" href="?page=<%=currentPage-1 %>" aria-label="Previous">
                                      <span aria-hidden="true">&laquo;</span>
                                      <span class="sr-only">Previous</span>
                                    </a>
                                  </li>
                                <% } %>
                                <% if (currentPage > 2) { %>
                                    <li class="page-item">
                                        <a class="page-link" href="?page=1">1</a>
                                    </li>
                                    <% if (currentPage > 3) { %>
                                        <li class="page-item disabled"><span class="page-link">...</span></li>
                                    <% } %>
                                <% } %>
                                
                                <% for (let i = Math.max(1, currentPage - 1); i <= Math.min(totalPage, currentPage + 1); i++) { %>
                                    <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                                        <a class="page-link" href="?page=<%= i %>"><%= i %></a>
                                    </li>
                                <% } %>
                                
                                <% if (currentPage < totalPage - 1) { %>
                                    <% if (currentPage < totalPage - 2) { %>
                                        <li class="page-item disabled"><span class="page-link">...</span></li>
                                    <% } %>
                                    <li class="page-item">
                                        <a class="page-link" href="?page=<%= totalPage %>"><%= totalPage %></a>
                                    </li>
                                <% } %>
                                <% if (currentPage<totalPage) { %>
                                 <li class="page-item">
                                    <a class="page-link" href="?page=<%=currentPage +1 %>" aria-label="Next">
                                      <span aria-hidden="true">&raquo;</span>
                                      <span class="sr-only">Next</span>
                                    </a>
                                  </li>
                                <% } %>
                                  
                                </ul>
                              </nav>
                            </div>
                            

                        </div>
                       

                    </div>

                </div>


            </div>
        </div>
    </div>

    <script src="/profile/jquery.min.js"></script>
    <!-- Include Bootstrap JS -->
    <!-- <script src="/profile/bootstrap.bundle.min.js"></script> -->

    <script src='https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.bundle.min.js'></script>


    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>

    </script>




    <script>
        // async function editAddress(addressId) {
        // 	console.log(addressId) 
        // 	window.location.href = `/user/editAddress?id=${addressId}`;
        // }

        document.getElementById('amountForm').addEventListener('submit', async function (event) {
            event.preventDefault()
            let valid = true;
            const moneyInput = document.getElementById('moneyInput');
            const moneyInputMessage = document.getElementById('moneyInputMessage');
            const form = document.getElementById('amountForm');



            if (!/^[1-9]\d*$/.test(moneyInput.value)) {
                moneyInput.value = moneyInput.value.replace(/[^0-9]/g, '');
                moneyInputMessage.innerText = "Only numeric values are allowed.";
                valid = false
            } else if (moneyInput.value.length > 5 || moneyInput.value < 0 || moneyInput.value > 10001) {
                moneyInputMessage.innerText = "Amount must be between 0 and 10001 with a maximum length of 5 digits.";
                valid = false
            } else {
                moneyInputMessage.innerText = "";
            }


            if (moneyInput.value < 100 || moneyInput.value > 10000 || moneyInput.value.length > 5 || moneyInput.value.length < 1) {
                event.preventDefault();
                moneyInputMessage.innerText = "Please enter a valid amount between 0 and 10001 .";
                valid = false
            }

            const amount = moneyInput.value;

            if (valid) {
                console.log(amount, 'ithanu amount ')
                const confirmation = await Swal.fire({
                    title: 'Are you sure?',
                    text: 'You won\'t be able to revert this!',
                    icon: 'warning',
                    toast: 'true',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, proceed it!'
                });

                if (confirmation.isConfirmed) {
                    try {

                        const response = await fetch('/user/wallet/add-money', {
                            method: "POST",
                            headers: {
                                'Content-Type': 'application/json'

                            },
                            body: JSON.stringify({ amount })
                        })
                        const data = await response.json();
                        console.log(data, 'this is the response data')

                        if (data.success) {
                            const options = {
                                "key": data.key_id,
                                "amount": data.amount,
                                "currency": "INR",
                                "name": "TICKER",
                                "description": "Order Payment ",
                                "image": "/image/download.png",
                                "order_id": data.razorpayOrderId,
                                "handler": function (response) {

                                    console.log('Razorpay payment success', response);

                                    console.log(response, " this is sjignature")
                                    verifyPayment(response.razorpay_payment_id, response.razorpay_order_id, response.razorpay_signature);

                                },


                                "prefill": {
                                    "name": "User Name",
                                    "email": "example@gmail.com",
                                    "contact": "9562200681"
                                },
                                "notes": {
                                    "address": "Razorpay Corporate Office"
                                },
                                "theme": {
                                    "color": "#000000"
                                }
                            };

                            var paymentGateway = new Razorpay(options);

                            paymentGateway.open();
                            paymentGateway.on('payment.failed', function (response) {
                                console.log("ok boss")
                                setTimeout(() => {
                                    // paymentGateway.close();
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Failed!',
                                        text: 'Unable to process the order.'
                                    })

                                }, 1000)

                            });
                        } else {
                            await Swal.fire({
                                icon: 'warning',
                                toast: true,
                                showConfirmation: false,
                                position: 'top-end',
                                timer: 1000,
                                text: data.message || 'Unable to process the order'
                            });
                            // window.location.href = '/user/wallet';
                        }
                    } catch (error) {
                        console.error("Error deleting address: ", error.message);
                        Swal.fire({
                            icon: 'error',
                            text: 'Something went wrong while add money to wallet'
                        });
                    }
                }
            }


        })
        async function verifyPayment(rzy_paymentId) {
            try {

                const response = await fetch('/user/wallet/verify-add-money', {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ rzy_paymentId })
                })

                const data =await response.json();

                console.log(data, 'this is response data of verify payment ')
                if (data.success) {

                  await  Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        toast: true,
                        timer: 1000,
                        position: 'top-end',
                        showConfirmButton: false,
                        text:data.message,

                    }).then(() => {
                        console.log(data.message)
                        
                        window.location.href = '/user/wallet'
                    })
                } else {

                  await  Swal.fire({
                        icon: "error",
                        title: "Your payment is Failed",
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 1000,
                        text: data.message,
                    }).then(() => {
                        console.log(data.message)
                        
                        window.location.href = '/user/wallet'
                    })
                }
            } catch (error) {
                console.log(error.message)
            }
        }
    </script>


</body>

</html>